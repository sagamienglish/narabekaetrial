<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊñáÊ≥ï‰∏¶„ÅπÊõø„Åà„Éû„Çπ„Çø„Éº</title>
    <!-- Tailwind CSS („Éá„Ç∂„Ç§„É≥Áî®) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM („Ç¢„Éó„É™„ÅÆ„Ç®„É≥„Ç∏„É≥) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel („Éñ„É©„Ç¶„Ç∂„ÅßReact„ÇíÂãï„Åã„ÅôÂ§âÊèõÊ©ü) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes bounce-slight {
            0%, 100% { transform: translateY(0) scale(0.9); }
            50% { transform: translateY(-5px) scale(0.9); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-bounce-slight { animation: bounce-slight 2s infinite; transform-origin: bottom left; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .animate-slideUp { animation: slideUp 0.5s ease-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- „Ç¢„Ç§„Ç≥„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà (Lucide‰∫íÊèõSVG) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-.67 2.65l.1.27a2 2 0 0 1-.36 1.83l-.29.17a2 2 0 0 0 0 3.46l.29.17a2 2 0 0 1 .36 1.83l-.1.27a2 2 0 0 0 .67 2.65l.45.26a2 2 0 0 0 2 0l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 1 2 2h.44a2 2 0 0 1 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2 0l.45-.26a2 2 0 0 0 .67-2.65l-.1-.27a2 2 0 0 1 .36-1.83l.29-.17a2 2 0 0 0 0-3.46l-.29-.17a2 2 0 0 1-.36-1.83l.1-.27a2 2 0 0 0-.67-2.65l-.45-.26a2 2 0 0 0-2 0l-.18.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 1-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M8 22v-4.66"/><path d="M16 22v-4.66"/><path d="M12 14.66a2 2 0 0 0-2 2v2"/><path d="M12 14.66a2 2 0 0 1 2 2v2"/><path d="M18 2l-1.6 8.59a7 7 0 0 1-8.8 0L6 2"/></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const Flag = (props) => <IconBase {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;

        // --- ÂäπÊûúÈü≥ ---
        const playSound = (type) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            const now = ctx.currentTime;
            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'pop') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }
        };

        // --- „Éá„Éï„Ç©„É´„Éà„Éá„Éº„Çø ---
        const DEFAULT_DATA_CSV = `
I heard my parents talk about my grades.	‰∏°Ë¶™„ÅåÁßÅ„ÅÆÊàêÁ∏æ„Å´„Å§„ÅÑ„Å¶Ë©±„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÇíËÅû„ÅÑ„Åü„ÄÇ	Áü•Ë¶öÂãïË©û	grades: ÊàêÁ∏æ
We saw a police officer chasing a man.	ÁßÅ„Åü„Å°„ÅØË≠¶ÂÆò„ÅåÁî∑„ÅÆ‰∫∫„ÇíËøΩ„ÅÑ„Åã„Åë„Å¶„ÅÑ„Çã„ÅÆ„ÇíË¶ã„Åü„ÄÇ	Áü•Ë¶öÂãïË©û	chase: ËøΩ„ÅÑ„Åã„Åë„Çã
I saw a boy scolded by his father.	ÁßÅ„ÅØÂ∞ëÂπ¥„ÅåÁà∂Ë¶™„Å´Âè±„Çâ„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÇíË¶ã„Åü„ÄÇ	Áü•Ë¶öÂãïË©û	scold: Âè±„Çã (ÂèóÂãïÊÖã„Å´Ê≥®ÊÑè)
Didn‚Äôt you hear the phone ring?	ÈõªË©±„ÅåÈ≥¥„Çã„ÅÆ„ÅåËÅû„Åì„Åà„Åæ„Åõ„Çì„Åß„Åó„Åü„ÅãÔºü	Áü•Ë¶öÂãïË©û	ring: È≥¥„Çã
I watched my favorite baseball player talk about his team on YouTube.	ÁßÅ„ÅØÂ•Ω„Åç„Å™ÈáéÁêÉÈÅ∏Êâã„ÅåYouTube„ÅßËá™ÂàÜ„ÅÆ„ÉÅ„Éº„É†„Å´„Å§„ÅÑ„Å¶Ë©±„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÇíË¶ã„Åü„ÄÇ	Áü•Ë¶öÂãïË©û
I saw a deer surrounded by lions on TV.	ÁßÅ„ÅØ„ÉÜ„É¨„Éì„Åß„ÄÅ„Ç∑„Ç´„Åå„É©„Ç§„Ç™„É≥„Å´Âõ≤„Åæ„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÇíË¶ã„Åü„ÄÇ	Áü•Ë¶öÂãïË©û	surround: Âõ≤„ÇÄ / deer: „Ç∑„Ç´(ÂçòË§áÂêåÂΩ¢)
My mother made me clean the bathroom.	ÊØç„ÅØÁßÅ„Å´ÔºàË®Ä„ÅÑ„Å§„Åë„Å¶ÔºâÊµ¥ÂÆ§„ÅÆÊéÉÈô§„Çí„Åï„Åõ„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û	make O do: O„Å´(ÁÑ°ÁêÜ„ÇÑ„Çä)ÔΩû„Åï„Åõ„Çã
My mother let me play video games last night.	ÊØç„ÅØÊò®Â§ú„ÄÅÁßÅ„Å´„ÉÜ„É¨„Éì„Ç≤„Éº„É†„Çí„Åï„Åõ„Å¶„Åè„Çå„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û	let O do: O„Å´ÔΩû„Åï„Åõ„Å¶„ÅÇ„Åí„Çã(Ë®±ÂèØ)
My mother had the doctor look at her leg.	ÊØç„ÅØÂåªËÄÖ„Å´Ë∂≥„ÇíË®∫„Å¶„ÇÇ„Çâ„Å£„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û	have O do: O„Å´ÔΩû„Åó„Å¶„ÇÇ„Çâ„ÅÜ(‰æùÈ†º)
My coach let me go home early because I felt sick.	Ê∞óÂàÜ„ÅåÊÇ™„Åã„Å£„Åü„ÅÆ„Åß„ÄÅ„Ç≥„Éº„ÉÅ„ÅØÁßÅ„ÇíÊó©ÈÄÄ„Åï„Åõ„Å¶„Åè„Çå„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û	go home early: Êó©ÈÄÄ„Åô„Çã
The teacher made me clean the classroom by myself.	ÂÖàÁîü„ÅØÁßÅ„Å´„Å≤„Å®„Çä„ÅßÊïôÂÆ§„ÅÆÊéÉÈô§„Çí„Åï„Åõ„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û	by myself: „Å≤„Å®„Çä„Åß
At the hotel, I had the staff carry my bag to the room.	„Éõ„ÉÜ„É´„Åß„ÄÅÁßÅ„ÅØ„Çπ„Çø„ÉÉ„Éï„Å´ÈÉ®Â±ã„Åæ„Åß„Ç´„Éê„É≥„ÇíÈÅã„Çì„Åß„ÇÇ„Çâ„Å£„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û
My parents let me go to USJ with my friends.	‰∏°Ë¶™„ÅØÁßÅ„ÇíÂèã„Å†„Å°„Å®USJ„Å´Ë°å„Åã„Åõ„Å¶„Åè„Çå„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û
The comedian was made to drink Aojiru as a penalty for the game.	„Åù„ÅÆËä∏‰∫∫„ÅØ„Ç≤„Éº„É†„ÅÆÁΩ∞„Å®„Åó„Å¶ÈùíÊ±Å„ÇíÈ£≤„Åæ„Åï„Çå„Åü„ÄÇ	‰ΩøÂΩπÂãïË©û	penalty: ÁΩ∞ / make„ÅÆÂèóÂãïÊÖã„ÅØto„ÅåÂøÖË¶Å
He asked me if I had seen the movie.	ÂΩº„ÅØÁßÅ„Å´„ÄÅ„Åù„ÅÆÊò†Áîª„ÇíË¶ã„Åü„Åã„Å©„ÅÜ„ÅãÂ∞ã„Å≠„Åü„ÄÇ	Êé•Á∂öË©û	ask + O + if...: O„Å´ÔΩû„Åã„Å©„ÅÜ„ÅãÂ∞ã„Å≠„Çã
My mother asked me when I would come home.	ÊØç„ÅØÁßÅ„Å´„ÄÅ„ÅÑ„Å§Â∏∞„Å£„Å¶„Åè„Çã„ÅÆ„ÅãÂ∞ã„Å≠„Åü„ÄÇ	Êé•Á∂öË©û
My friends asked me if I wanted to play e-sports.	ÂèãÈÅî„ÅØÁßÅ„Å´e„Çπ„Éù„Éº„ÉÑ„Çí„ÇÑ„Çä„Åü„ÅÑ„Åã„Å©„ÅÜ„ÅãÂ∞ã„Å≠„Åü„ÄÇ	Êé•Á∂öË©û
Jane asked me what I was doing.	Jane„ÅØÁßÅ„Å´‰Ωï„Çí„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅãÂ∞ã„Å≠„Åü„ÄÇ	Êé•Á∂öË©û
Some parents ask me if e-sports is a real sport.	‰Ωï‰∫∫„Åã„ÅÆ‰∏°Ë¶™„ÅØÁßÅ„Å´e„Çπ„Éù„Éº„ÉÑ„ÅØÊú¨ÂΩì„ÅÆ„Çπ„Éù„Éº„ÉÑ„Å™„ÅÆ„Åã„Å©„ÅÜ„ÅãÂ∞ã„Å≠„Åü„ÄÇ	Êé•Á∂öË©û
The e-sports player told us why he needed mental skills.	e„Çπ„Éù„Éº„ÉÑ„Éó„É¨„Éº„É§‚Äï„Åü„Å°„ÅØÁßÅ„Åü„Å°„Å´„Å™„ÅúÁ≤æÁ•ûÁöÑ„Çπ„Ç≠„É´„ÅåÂøÖË¶Å„Å™„ÅÆ„Åã‰ºù„Åà„Åü„ÄÇ	Êé•Á∂öË©û	mental skills: Á≤æÁ•ûÁöÑ„Å™ÊäÄË°ì
`.trim();

        // ÂãïË©û„É™„Çπ„Éà
        const VERB_LIST = [
            "heard", "talk", "saw", "chasing", "scolded", "hear", "ring", "watched", 
            "surrounded", "made", "clean", "let", "play", "had", "look", "go", "felt", 
            "carry", "drink", "asked", "seen", "come", "wanted", "doing", "is", "told", "needed"
        ];

        // ÁµêÂêàÂØæË±°„ÅÆÂçòË™û
        const PREFIX_WORDS = ['a', 'an', 'the', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'this', 'that', 'some', 'any'];

        // --- „Éû„Çπ„Ç≥„ÉÉ„Éà„Ç≠„É£„É©„ÇØ„Çø„Éº: „Éï„ÇØ„É≠„Ç¶ÂÖàÁîü ---
        const MascotOwl = ({ emotion, message }) => {
            const formattedMessage = message ? message.split('\n').map((str, index) => (
                <React.Fragment key={index}>
                    {str}
                    {index !== message.split('\n').length - 1 && <br />}
                </React.Fragment>
            )) : null;

            return (
                <div className="relative flex items-center animate-bounce-slight transform scale-90 origin-bottom-left">
                    {/* Owl SVG */}
                    <svg width="70" height="70" viewBox="0 0 100 100" className="drop-shadow-md z-20">
                        <ellipse cx="50" cy="55" rx="35" ry="40" fill="#60A5FA" /> 
                        <ellipse cx="50" cy="65" rx="25" ry="28" fill="#FEF3C7" />
                        <path d="M25 30 L15 10 L40 25 Z" fill="#60A5FA" />
                        <path d="M75 30 L85 10 L60 25 Z" fill="#60A5FA" />
                        <circle cx="35" cy="45" r="12" fill="white" stroke="#2563EB" strokeWidth="2"/>
                        <circle cx="65" cy="45" r="12" fill="white" stroke="#2563EB" strokeWidth="2"/>
                        {emotion === 'happy' ? (
                        <>
                            <path d="M28 45 Q35 40 42 45" stroke="#2563EB" strokeWidth="3" fill="none" />
                            <path d="M58 45 Q65 40 72 45" stroke="#2563EB" strokeWidth="3" fill="none" />
                        </>
                        ) : emotion === 'sad' ? (
                        <>
                            <circle cx="35" cy="48" r="3" fill="#2563EB" />
                            <circle cx="65" cy="48" r="3" fill="#2563EB" />
                            <path d="M45 20 L30 25" stroke="white" strokeWidth="2" />
                        </>
                        ) : (
                        <>
                            <circle cx="35" cy="45" r="4" fill="#2563EB" />
                            <circle cx="65" cy="45" r="4" fill="#2563EB" />
                        </>
                        )}
                        <path d="M45 55 L55 55 L50 65 Z" fill="#F59E0B" />
                        <path d="M15 55 Q10 70 20 80" stroke="#3B82F6" strokeWidth="3" fill="none" />
                        <path d="M85 55 Q90 70 80 80" stroke="#3B82F6" strokeWidth="3" fill="none" />
                    </svg>
                    {/* Âêπ„ÅçÂá∫„Åó */}
                    {formattedMessage && (
                        <div className="ml-3 bg-white border-2 border-blue-200 p-2 rounded-xl rounded-bl-none shadow-lg text-xs md:text-sm text-blue-900 font-bold min-w-[140px] max-w-[200px] z-20 animate-fadeIn leading-relaxed self-start mt-2">
                            {formattedMessage}
                        </div>
                    )}
                </div>
            );
        };

        // --- ÂÜÜÂΩ¢„Çø„Ç§„Éû„Éº ---
        const CircularTimer = ({ timeLeft, maxTime }) => {
            const radius = 16;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference - (timeLeft / maxTime) * circumference;
            const colorClass = timeLeft < 10 ? "text-red-500" : "text-blue-500";

            return (
                <div className="relative w-12 h-12 flex items-center justify-center">
                    <svg className="w-full h-full transform -rotate-90">
                        <circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="3" fill="transparent" className="text-gray-200"/>
                        <circle cx="24" cy="24" r={radius} stroke="currentColor" strokeWidth="3" fill="transparent"
                        strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round"
                        className={`${colorClass} transition-all duration-1000 ease-linear`}
                        />
                    </svg>
                    <div className={`absolute text-xs font-bold ${colorClass}`}>{timeLeft}</div>
                </div>
            );
        };

        // --- Â≠¶ÁøíÂ±•Ê≠¥Ë°®Á§∫„Ç´„Éº„Éâ ---
        const StatsCard = ({ stats }) => (
            <div className="bg-white border border-gray-100 rounded-xl p-4 shadow-sm w-full max-w-sm animate-fadeIn">
                <div className="flex items-center justify-between mb-3">
                    <div className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center">
                        <Activity size={14} className="mr-1"/> Learning Stats
                    </div>
                </div>
                <div className="flex justify-around text-center divide-x divide-gray-100">
                    <div className="px-2 flex flex-col items-center">
                        <div className="text-2xl font-bold text-green-500">{stats.totalCorrect || 0}</div>
                        <div className="text-[10px] text-gray-500 flex items-center mt-1">
                            <CheckCircle size={10} className="mr-1"/> Total Correct
                        </div>
                    </div>
                    <div className="px-2 flex flex-col items-center">
                        <div className="text-2xl font-bold text-orange-500">{stats.trialHighScore || 0}</div>
                        <div className="text-[10px] text-gray-500 flex items-center mt-1">
                            <Trophy size={10} className="mr-1"/> High Score
                        </div>
                    </div>
                    <div className="px-2 flex flex-col items-center">
                        <div className="text-2xl font-bold text-blue-500">{(stats.learningGames || 0) + (stats.trialGames || 0)}</div>
                        <div className="text-[10px] text-gray-500 flex items-center mt-1">
                            <Play size={10} className="mr-1"/> Games
                        </div>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            // State
            const [allQuestions, setAllQuestions] = useState([]);
            const [playQuestions, setPlayQuestions] = useState([]);
            const [categories, setCategories] = useState([]);
            
            const [mode, setMode] = useState('menu');
            const [currentQIndex, setCurrentQIndex] = useState(0);
            
            // Game State
            const [shuffledWords, setShuffledWords] = useState([]);
            const [selectedWords, setSelectedWords] = useState([]);
            const [draggedItem, setDraggedItem] = useState(null);
            
            const [score, setScore] = useState(0); 
            const [correctCount, setCorrectCount] = useState(0); 
            const [questionStartTime, setQuestionStartTime] = useState(0); 
            
            const [timeLeft, setTimeLeft] = useState(60);
            const [maxTime, setMaxTime] = useState(60);
            const [isTimerActive, setIsTimerActive] = useState(false);
            
            const [mistakes, setMistakes] = useState([]);
            const [showJapanese, setShowJapanese] = useState(true);
            const [feedback, setFeedback] = useState(null);
            const [hintLevel, setHintLevel] = useState(0); 
            
            // Stats
            const [stats, setStats] = useState({ learningGames: 0, trialGames: 0, totalCorrect: 0, trialHighScore: 0 });

            // Settings
            const [rawCsvData, setRawCsvData] = useState(DEFAULT_DATA_CSV);
            
            // ÂàùÊúüÂåñ
            useEffect(() => {
                const savedStats = localStorage.getItem('grammarAppStats');
                if (savedStats) {
                    const parsed = JSON.parse(savedStats);
                    if (parsed.trialHighScore === undefined) {
                        setStats({
                            learningGames: parsed.learningGames || parsed.gamesPlayed || 0,
                            trialGames: parsed.trialGames || 0,
                            totalCorrect: parsed.totalScore || 0,
                            trialHighScore: 0
                        });
                    } else {
                        setStats(parsed);
                    }
                }

                const savedCsv = localStorage.getItem('grammarAppCsvData');
                const savedTime = localStorage.getItem('grammarAppTimeLimit');

                if (savedCsv) setRawCsvData(savedCsv);
                if (savedTime) setMaxTime(Number(savedTime));
            }, []);

            useEffect(() => {
                const { loaded, cats } = parseCSV(rawCsvData);
                setAllQuestions(loaded);
                setCategories(cats);
            }, [rawCsvData]);

            const saveSettings = () => {
                localStorage.setItem('grammarAppCsvData', rawCsvData);
                localStorage.setItem('grammarAppTimeLimit', maxTime);
                setMode('menu');
            };

            const updateStats = (finalCorrectCount, finalScore, gameMode) => {
                const newStats = { ...stats };
                
                if (gameMode === 'learning') {
                    newStats.learningGames = (newStats.learningGames || 0) + 1;
                } else if (gameMode === 'trial') {
                    newStats.trialGames = (newStats.trialGames || 0) + 1;
                    if (finalScore > (newStats.trialHighScore || 0)) {
                        newStats.trialHighScore = finalScore;
                    }
                }
                
                newStats.totalCorrect = (newStats.totalCorrect || 0) + finalCorrectCount;
                
                setStats(newStats);
                localStorage.setItem('grammarAppStats', JSON.stringify(newStats));
            };

            const parseCSV = (csv) => {
                const cats = new Set();
                const loaded = csv.split('\n').map((line, index) => {
                    const parts = line.split('\t');
                    if (parts.length < 2) return null;
                    
                    const original = parts[0].trim();
                    let cleanOriginal = original;
                    let punctuation = "";

                    if (original.match(/[.?!]$/)) {
                        punctuation = original.slice(-1);
                        cleanOriginal = original.slice(0, -1);
                    }

                    let words = cleanOriginal.split(/\s+/);
                    if (words.length > 0 && words[0] !== "I") {
                        words[0] = words[0].toLowerCase();
                    }

                    if (words.length >= 8) {
                        const groupedWords = [];
                        let i = 0;
                        while (i < words.length) {
                            const w = words[i];
                            const cleanW = w.toLowerCase().replace(/[^a-z]/g, '');
                            if (PREFIX_WORDS.includes(cleanW) && i + 1 < words.length) {
                                groupedWords.push(w + " " + words[i+1]);
                                i += 2;
                            } else {
                                groupedWords.push(w);
                                i++;
                            }
                        }
                        words = groupedWords;
                    }

                    const category = parts[2] ? parts[2].trim() : "‰∏ÄËà¨";
                    const specificHint = parts[3] ? parts[3].trim() : "";
                    cats.add(category);

                    return {
                        id: index,
                        original: original,
                        cleanOriginal: cleanOriginal,
                        punctuation: punctuation,
                        japanese: parts[1] ? parts[1].trim() : "",
                        category: category,
                        specificHint: specificHint,
                        words: words
                    };
                }).filter(q => q !== null);

                return { loaded, cats: Array.from(cats) };
            };

            const startGame = (gameMode, category = null) => {
                let qList = [];
                if (gameMode === 'review') {
                    if (mistakes.length === 0) return alert("Âæ©Áøí„Åô„ÇãÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
                    qList = [...mistakes];
                } else {
                    let pool = [...allQuestions];
                    if (category && category !== 'ALL') {
                        pool = pool.filter(q => q.category === category);
                    }
                    pool.sort(() => Math.random() - 0.5);
                    qList = pool.slice(0, 5); 
                }

                if (qList.length === 0) return alert("ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");

                setPlayQuestions(qList);
                setCurrentQIndex(0);
                setScore(0);
                setCorrectCount(0);
                if (gameMode !== 'review') setMistakes([]);
                
                loadQuestion(qList[0]);

                if (gameMode === 'trial') {
                    setTimeLeft(maxTime);
                    setIsTimerActive(true);
                    setMode('trial');
                } else {
                    setIsTimerActive(false);
                    setMode('learning');
                }
            };

            const loadQuestion = (question) => {
                if (!question) return;
                setHintLevel(0);
                setFeedback(null);
                setSelectedWords([]);
                setQuestionStartTime(Date.now()); 
                
                const words = question.words.map((w, i) => ({ 
                    text: w, 
                    id: `q${question.id}-w${i}-${Math.random().toString(36).substr(2,5)}` 
                }));
                setShuffledWords(words.sort(() => Math.random() - 0.5));
            };

            useEffect(() => {
                let timer;
                if (isTimerActive && timeLeft > 0 && mode === 'trial') {
                    timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
                } else if (timeLeft === 0 && isTimerActive) {
                    setIsTimerActive(false);
                    finishGame();
                }
                return () => clearInterval(timer);
            }, [isTimerActive, timeLeft, mode]);

            const finishGame = () => {
                setIsTimerActive(false);
                setMode('result');
                if (mode === 'learning' || mode === 'trial') {
                    updateStats(correctCount, score, mode);
                }
            };

            // --- Drag & Drop Updates ---
            const handleDragStart = (e, word, fromBank) => {
                if (feedback === 'correct' || feedback === 'giveup') return;
                setDraggedItem({ word, fromBank });
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e) => {
                e.preventDefault(); e.dataTransfer.dropEffect = "move";
            };

            const handleDrop = (e, targetArea) => {
                e.preventDefault();
                if (!draggedItem) return;
                
                // ÂõûÁ≠î„Ç®„É™„Ç¢„Å∏„ÅÆ„Éâ„É≠„ÉÉ„ÉóÔºàÁ©∫ÁôΩÈÉ®ÂàÜ„Å∏„ÅÆ„Éâ„É≠„ÉÉ„ÉóÊâ±„ÅÑÔºâ
                if (targetArea === 'answer') {
                    if (draggedItem.fromBank) {
                        moveWord(draggedItem.word, true); // „Éê„É≥„ÇØ„Åã„ÇâÊú´Â∞æ„Å´ËøΩÂä†
                    } else {
                        // ÂõûÁ≠î„Ç®„É™„Ç¢ÂÜÖ„Åß„ÅÆÁßªÂãïÔºàÊú´Â∞æ„Å∏„ÅÆÁßªÂãïÔºâ
                        const newSelected = [...selectedWords];
                        const draggedIndex = newSelected.findIndex(w => w.id === draggedItem.word.id);
                        if (draggedIndex !== -1) {
                            const [removed] = newSelected.splice(draggedIndex, 1);
                            newSelected.push(removed);
                            setSelectedWords(newSelected);
                        }
                    }
                } 
                // „Éê„É≥„ÇØ„Å∏„ÅÆ„Éâ„É≠„ÉÉ„ÉóÔºàÊàª„ÅôÔºâ
                else if (targetArea === 'bank' && !draggedItem.fromBank) {
                    moveWord(draggedItem.word, false);
                }
                setDraggedItem(null);
            };

            // „Ç´„Éº„ÉâÂêåÂ£´„ÅÆ‰∏¶„ÅπÊõø„Åà„ÉªÊåøÂÖ•„É≠„Ç∏„ÉÉ„ÇØ
            const handleCardDrop = (e, targetWord) => {
                e.preventDefault();
                e.stopPropagation(); // „Ç®„É™„Ç¢„ÅÆonDropÁô∫ÁÅ´„ÇíÈò≤„Åê
                
                if (!draggedItem) return;
                const draggedWord = draggedItem.word;
                
                // 1. ÂõûÁ≠î„Ç®„É™„Ç¢ÂÜÖ„Åß„ÅÆ‰∏¶„ÅπÊõø„Åà
                if (!draggedItem.fromBank && selectedWords.some(w => w.id === targetWord.id)) {
                    const newSelected = [...selectedWords];
                    const draggedIndex = newSelected.findIndex(w => w.id === draggedWord.id);
                    const targetIndex = newSelected.findIndex(w => w.id === targetWord.id);
                    
                    if (draggedIndex !== -1 && targetIndex !== -1) {
                        const [removed] = newSelected.splice(draggedIndex, 1);
                        newSelected.splice(targetIndex, 0, removed);
                        setSelectedWords(newSelected);
                    }
                }
                // 2. „Éê„É≥„ÇØ„Åã„ÇâÂõûÁ≠î„Ç®„É™„Ç¢„ÅÆÁâπÂÆö‰ΩçÁΩÆ„Å∏„ÅÆÊåøÂÖ•
                else if (draggedItem.fromBank && selectedWords.some(w => w.id === targetWord.id)) {
                    // „Éê„É≥„ÇØ„Åã„ÇâÂâäÈô§
                    setShuffledWords(prev => prev.filter(w => w.id !== draggedWord.id));
                    // ÂõûÁ≠î„Ç®„É™„Ç¢„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà‰ΩçÁΩÆ„Å´ÊåøÂÖ•
                    const newSelected = [...selectedWords];
                    const targetIndex = newSelected.findIndex(w => w.id === targetWord.id);
                    newSelected.splice(targetIndex, 0, draggedWord);
                    setSelectedWords(newSelected);
                }
                
                setDraggedItem(null);
            };

            const handleWordClick = (word, fromBank) => {
                if (feedback === 'correct' || feedback === 'giveup') return;
                playSound('pop');
                moveWord(word, fromBank);
            };

            const moveWord = (word, fromBank) => {
                if (fromBank) {
                    setShuffledWords(prev => prev.filter(w => w.id !== word.id));
                    setSelectedWords(prev => [...prev, word]);
                } else {
                    setSelectedWords(prev => prev.filter(w => w.id !== word.id));
                    setShuffledWords(prev => [...prev, word]);
                }
            };

            const calculateScorePoints = () => {
                const basePoints = 1000;
                const duration = (Date.now() - questionStartTime) / 1000;
                const timePenalty = Math.floor(duration) * 10;
                const hintPenalty = hintLevel * 300;
                
                let p = basePoints - timePenalty - hintPenalty;
                if (p < 100) p = 100; 
                return p;
            };

            const checkAnswer = () => {
                const currentQ = playQuestions[currentQIndex];
                const userSentence = selectedWords.map(w => w.text).join(' ');
                const isCorrect = userSentence.replace(/\s+/g, ' ').trim().toLowerCase() === currentQ.cleanOriginal.replace(/\s+/g, ' ').trim().toLowerCase();

                if (isCorrect) {
                    handleCorrect();
                } else {
                    setFeedback('wrong');
                    playSound('wrong');
                    if (!mistakes.find(m => m.id === currentQ.id)) {
                        setMistakes(prev => [...prev, currentQ]);
                    }
                }
            };

            const handleCorrect = () => {
                const currentQ = playQuestions[currentQIndex];
                setFeedback('correct');
                playSound('correct');
                speakText(currentQ.original);
                
                setCorrectCount(prev => prev + 1);
                
                if (mode === 'trial') {
                    const points = calculateScorePoints();
                    setScore(prev => prev + points);
                } else {
                    setScore(prev => prev + 1);
                }
            };

            const handleGiveUp = () => {
                const currentQ = playQuestions[currentQIndex];
                setFeedback('giveup');
                playSound('wrong');
                speakText(currentQ.original);
                if (!mistakes.find(m => m.id === currentQ.id)) {
                    setMistakes(prev => [...prev, currentQ]);
                }
            };

            const nextQuestion = () => {
                if (currentQIndex + 1 < playQuestions.length) {
                    setCurrentQIndex(prev => prev + 1);
                    loadQuestion(playQuestions[currentQIndex + 1]);
                } else {
                    finishGame();
                }
            };

            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const uttr = new SpeechSynthesisUtterance(text);
                    uttr.lang = 'en-US';
                    window.speechSynthesis.speak(uttr);
                }
            };

            const getOwlMessage = () => {
                const currentQ = playQuestions[currentQIndex];
                if (feedback === 'correct') {
                    if (mode === 'trial') return `Nice!\n+${calculateScorePoints()}pts`; 
                    return "Great Job!\n„Åù„ÅÆË™øÂ≠êÔºÅ";
                }
                if (feedback === 'giveup') return "Don't worry.\nÂàá„ÇäÊõø„Åà„Çà„ÅÜÔºÅ";
                if (feedback === 'wrong') return "Oops!\nÊÉú„Åó„ÅÑÔºÅ";
                if (hintLevel === 1) return `ÂãïË©û„ÅØ\n"${getVerbHint()}" „Å†„ÇàÔºÅ`;
                if (hintLevel === 2) return "ÊñáÊ≥ï„ÇÑË™ûÂè•„ÅÆ„Éí„É≥„Éà\n„ÇíË¶ã„Å¶„Åø„Å¶ÔºÅ";
                return "";
            };

            const getOwlEmotion = () => {
                if (feedback === 'correct') return 'happy';
                if (feedback === 'wrong' || feedback === 'giveup') return 'sad';
                return 'neutral';
            };

            const isVerb = (text) => {
                const firstWord = text.split(' ')[0].toLowerCase().replace(/[.,?]/g, '');
                return VERB_LIST.includes(firstWord);
            };
            const getVerbHint = () => {
                const currentQ = playQuestions[currentQIndex];
                const verbs = currentQ.words.filter(w => isVerb(w));
                return verbs.join(", ");
            };
            const getGrammarHint = (cat) => {
                if (cat.includes('Áü•Ë¶ö')) return "Áü•Ë¶öÂãïË©û(see/hear) + O + ÂéüÂûã/ing (O„ÅåÔΩû„Åô„Çã„ÅÆ„ÇíË¶ã„Çã)";
                if (cat.includes('‰ΩøÂΩπ')) return "‰ΩøÂΩπÂãïË©û(make/let) + O + ÂéüÂûã (O„Å´ÔΩû„Åï„Åõ„Çã)";
                if (cat.includes('Êé•Á∂öË©û')) return "Êé•Á∂öË©û„ÅÆÂæå„ÅØ [S + V] „ÅÆË™ûÈ†Ü„Å´„Å™„Çã„ÇàÔºÅ";
                return "Ë™ûÈ†Ü„ÅÆ„É´„Éº„É´„ÇíÊÄù„ÅÑÂá∫„Åó„Å¶ÔºÅ";
            };

            const getCardStyle = (word, isSelectedArea) => {
                let style = "px-3 py-2 m-1 rounded bg-white border-2 border-gray-200 shadow-sm font-medium cursor-grab active:cursor-grabbing select-none transition-transform hover:scale-105 ";
                if (word.text.includes(' ')) style += "border-b-4 border-blue-100 ";
                if (hintLevel >= 1 && isVerb(word.text)) style += " !font-bold !text-blue-700 !border-blue-400 !bg-blue-50 ring-2 ring-blue-200 ";
                return style;
            };

            // --- Render ---
            if (mode === 'menu') {
                return (
                    <div className="flex flex-col items-center justify-center h-full space-y-6 py-8 animate-fadeIn w-full">
                        <div className="text-center mb-4">
                            <h1 className="text-3xl font-extrabold text-blue-600 mb-2">ÊñáÊ≥ï‰∏¶„ÅπÊõø„Åà„Éû„Çπ„Çø„Éº</h1>
                            <div className="flex justify-center mb-2">
                                <MascotOwl emotion="happy" message="" />
                            </div>
                        </div>
                        <StatsCard stats={stats} />
                        <div className="w-full max-w-xs space-y-3">
                            <button onClick={() => setMode('category_select')} className="w-full flex items-center p-4 bg-white border-2 border-blue-100 rounded-xl shadow-sm hover:border-blue-500 transition-all group">
                                <div className="bg-blue-100 p-2 rounded-full mr-3 text-blue-600 group-hover:bg-blue-600 group-hover:text-white"><BookOpen size={20} /></div>
                                <div className="text-left"><div className="font-bold text-gray-800">Â≠¶Áøí„É¢„Éº„Éâ</div><div className="text-xs text-gray-500">Ëß£Ë™¨‰ªò„Åç„Åß„Åò„Å£„Åè„Çä</div></div>
                            </button>
                            <button onClick={() => startGame('trial')} className="w-full flex items-center p-4 bg-white border-2 border-orange-100 rounded-xl shadow-sm hover:border-orange-500 transition-all group">
                                <div className="bg-orange-100 p-2 rounded-full mr-3 text-orange-600 group-hover:bg-orange-600 group-hover:text-white"><Clock size={20} /></div>
                                <div className="text-left"><div className="font-bold text-gray-800">„Çø„Ç§„É†„Éà„É©„Ç§„Ç¢„É´</div><div className="text-xs text-gray-500">„Çπ„Ç≥„Ç¢„Ç¢„Çø„ÉÉ„ÇØ</div></div>
                            </button>
                            {mistakes.length > 0 && (
                                <button onClick={() => startGame('review')} className="w-full flex items-center p-4 bg-white border-2 border-red-100 rounded-xl shadow-sm hover:border-red-500 transition-all group">
                                    <div className="bg-red-100 p-2 rounded-full mr-3 text-red-600 group-hover:bg-red-600 group-hover:text-white"><RotateCcw size={20} /></div>
                                    <div className="text-left"><div className="font-bold text-gray-800">Âæ©Áøí„É¢„Éº„Éâ</div><div className="text-xs text-gray-500">Ëã¶Êâã„Å™{mistakes.length}Âïè„ÇíÂÖãÊúç</div></div>
                                </button>
                            )}
                        </div>
                        <button onClick={() => setMode('settings')} className="text-gray-400 hover:text-gray-600 flex items-center text-xs mt-4"><Settings size={14} className="mr-1" /> ÊïôÂì°Áî®Ë®≠ÂÆö</button>
                    </div>
                );
            }

            if (mode === 'category_select') {
                return (
                    <div className="flex flex-col h-full py-4 px-4">
                        <div className="flex items-center justify-between mb-4">
                            <button onClick={() => setMode('menu')} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><X size={20}/></button>
                            <h2 className="text-lg font-bold text-gray-800">„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû</h2><div className="w-8"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto grid grid-cols-2 gap-3 pb-4 max-w-2xl mx-auto w-full">
                            <button onClick={() => startGame('learning', 'ALL')} className="p-3 rounded-lg border-2 border-blue-100 bg-blue-50 text-blue-800 font-bold hover:bg-blue-100 text-sm text-center col-span-2">„Åô„Åπ„Å¶ („É©„É≥„ÉÄ„É†)</button>
                            {categories.map(cat => (<button key={cat} onClick={() => startGame('learning', cat)} className="p-3 rounded-lg border-2 border-gray-100 hover:border-blue-400 hover:bg-white transition-all font-medium text-gray-700 text-sm text-center shadow-sm">{cat}</button>))}
                        </div>
                    </div>
                );
            }

            if (mode === 'settings') {
                return (
                    <div className="p-4 max-w-xl mx-auto h-full flex flex-col">
                        <div className="flex items-center justify-between mb-4"><h2 className="text-lg font-bold flex items-center text-gray-800"><Settings className="mr-2"/> Ë®≠ÂÆö</h2><button onClick={() => setMode('menu')} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><X size={20}/></button></div>
                        <div className="mb-4 flex-1 flex flex-col">
                            <label className="block text-xs font-bold mb-1 text-gray-700">ÂïèÈ°å„Éá„Éº„Çø (CSV)</label>
                            <div className="text-xs text-gray-500 mb-2 bg-blue-50 p-2 rounded leading-tight">Ëã±Êñá[TAB]Êó•Êú¨Ë™û[TAB]„Ç´„ÉÜ„Ç¥„É™[TAB]Ëß£Ë™¨(ÁúÅÁï•ÂèØ)<br/>‚Äª4ÂàóÁõÆ„Å´Ë™ûÂè•„ÅÆËß£Ë™¨„Å™„Å©„ÇíÂÖ•„Çå„Çã„Å®„Éí„É≥„Éà2„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>
                            <textarea value={rawCsvData} onChange={(e) => setRawCsvData(e.target.value)} className="flex-1 p-2 border border-gray-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none resize-none"/>
                        </div>
                        <div className="mb-4"><label className="block text-xs font-bold mb-1 text-gray-700">Âà∂ÈôêÊôÇÈñì(Áßí)</label><input type="number" value={maxTime} onChange={(e) => setMaxTime(Number(e.target.value))} className="p-2 border border-gray-300 rounded-lg w-24 text-center"/></div>
                        <button onClick={saveSettings} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center"><Save size={18} className="mr-2"/> ‰øùÂ≠ò„Åó„Å¶Êàª„Çã</button>
                    </div>
                );
            }
            
            if (mode === 'result') {
                 return (
                    <div className="flex flex-col items-center justify-center h-full text-center py-10 px-4 animate-fadeIn">
                        <Trophy size={64} className="text-yellow-400 mb-4 drop-shadow-lg" />
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">ÁµêÊûúÁô∫Ë°®</h2>
                        <div className="mb-6">
                            {mode === 'trial' ? (
                                <div className="flex flex-col items-center">
                                    <span className="text-gray-500 text-sm">TOTAL SCORE</span>
                                    <span className="text-5xl font-extrabold text-orange-500">{score}</span>
                                    <span className="text-gray-400 text-sm mt-1">({correctCount} / {playQuestions.length} ÂïèÊ≠£Ëß£)</span>
                                </div>
                            ) : (
                                <span className="text-4xl font-bold text-blue-600">{score} / {playQuestions.length} ÂïèÊ≠£Ëß£</span>
                            )}
                        </div>
                        {mistakes.length > 0 && (
                            <div className="w-full max-w-sm bg-red-50 border border-red-100 rounded-xl p-4 mb-6 text-left overflow-y-auto max-h-40">
                                <div className="font-bold text-red-800 mb-2 text-xs flex items-center"><AlertCircle size={14} className="mr-1"/> Ë¶ÅÂæ©Áøí„É™„Çπ„Éà</div>
                                <ul className="space-y-2">{mistakes.map((m, i) => (<li key={i} className="text-xs text-gray-700 bg-white p-2 rounded border border-red-100">{m.original}</li>))}</ul>
                            </div>
                        )}
                        <div className="flex space-x-3">
                            <button onClick={() => setMode('menu')} className="px-6 py-3 bg-white border border-gray-300 text-gray-600 rounded-xl font-bold hover:bg-gray-50">„É°„Éã„É•„Éº</button>
                            <button onClick={() => startGame(mode === 'trial' ? 'trial' : 'learning', 'ALL')} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                        </div>
                    </div>
                );
            }

            // Game Render
            const currentQ = playQuestions[currentQIndex];
            if (!currentQ) return <div>Loading...</div>;

            return (
                <div className="flex flex-col h-full max-w-4xl mx-auto px-4 py-4 relative">
                    <div className="flex justify-between items-start mb-2">
                        <button onClick={() => setMode('menu')} className="text-gray-400 hover:text-gray-700"><X size={24} /></button>
                        <div className="flex flex-col items-center">
                            <div className="flex space-x-1 mb-1">
                                {playQuestions.map((_, idx) => (
                                    <div key={idx} className={`w-2 h-2 rounded-full ${idx === currentQIndex ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                                ))}
                            </div>
                            {mode === 'trial' ? (
                                <span className="text-lg font-bold text-orange-500">Score: {score}</span>
                            ) : (
                                <span className="text-xs text-gray-400 font-bold">{currentQ.category}</span>
                            )}
                        </div>
                        {mode === 'trial' ? <CircularTimer timeLeft={timeLeft} maxTime={maxTime} /> : <div className="w-8"></div>}
                    </div>

                    <div className="flex-1 flex flex-col justify-center min-h-0">
                        <div className="text-center mb-4">
                            <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-normal">{currentQ.japanese}</h2>
                        </div>
                        {(hintLevel > 0 && feedback !== 'correct') && (
                            <div className="mb-4 text-center animate-fadeIn z-30 relative flex flex-col items-center gap-2">
                                {hintLevel >= 1 && <div className="inline-block bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-full text-sm font-bold shadow-sm"><span>üí° „Éí„É≥„Éà1: ÂãïË©û„ÅØ „Äå<span className="text-blue-600">{getVerbHint()}</span>„Äç „Åß„ÅôÔºÅ</span></div>}
                                {hintLevel >= 2 && <div className="inline-block bg-orange-50 border border-orange-200 text-orange-800 px-4 py-2 rounded-full text-sm font-bold shadow-sm max-w-md"><div className="mb-1">üìò „Éí„É≥„Éà2: {getGrammarHint(currentQ.category)}</div>{currentQ.specificHint && <div className="border-t border-orange-200 pt-1 mt-1 text-xs text-orange-900 bg-orange-100 p-2 rounded"><span className="font-bold">Memo:</span> {currentQ.specificHint}</div>}</div>}
                            </div>
                        )}
                        <div className="space-y-6">
                            <div 
                                className={`min-h-[80px] rounded-xl p-3 flex flex-wrap items-center justify-center gap-2 border-2 border-dashed transition-colors ${feedback === 'correct' ? 'bg-green-50 border-green-300 border-solid' : 'bg-slate-50 border-slate-300'}`}
                                onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, 'answer')}
                            >
                                {selectedWords.length === 0 && <div className="text-gray-400 text-sm pointer-events-none flex items-center"><GripVertical size={16} className="mr-1 opacity-50"/> ÂçòË™û„Çí‰∏¶„Åπ„Å¶„Åè„Å†„Åï„ÅÑ</div>}
                                {selectedWords.map((word) => (
                                    <div 
                                        key={word.id} 
                                        draggable={!feedback} 
                                        onDragStart={(e) => handleDragStart(e, word, false)} 
                                        onDrop={(e) => handleCardDrop(e, word)}
                                        onClick={() => handleWordClick(word, false)} 
                                        className={getCardStyle(word, true)}
                                    >
                                        {word.text}
                                    </div>
                                ))}
                                {currentQ.punctuation && <div className="text-xl font-bold text-gray-800 self-center pt-1">{currentQ.punctuation}</div>}
                            </div>
                            <div className="flex flex-wrap justify-center gap-2 min-h-[60px]" onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, 'bank')}>
                                {shuffledWords.map((word) => (
                                    <div key={word.id} draggable={!feedback} onDragStart={(e) => handleDragStart(e, word, true)} onClick={() => handleWordClick(word, true)} className={getCardStyle(word, false)}>{word.text}</div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="mt-auto pt-4 relative">
                        <div className="absolute left-0 bottom-16 hidden md:block pointer-events-none z-0"><MascotOwl emotion={getOwlEmotion()} message={getOwlMessage()} /></div>
                        {feedback === 'correct' || feedback === 'giveup' ? (
                            <div className="bg-white border-2 border-blue-100 shadow-xl rounded-2xl p-4 animate-slideUp z-10 relative">
                                <div className="flex items-center justify-between mb-2">
                                    <div className={`flex items-center font-bold text-lg ${feedback==='correct' ? 'text-green-700' : 'text-gray-600'}`}>{feedback==='correct' ? <CheckCircle className="mr-2"/> : <Flag className="mr-2"/>}{feedback==='correct' ? 'Correct!' : 'Answer'}</div>
                                    <button onClick={() => speakText(currentQ.original)} className="p-2 bg-gray-100 rounded-full hover:bg-blue-100 hover:text-blue-600"><Volume2 size={20} /></button>
                                </div>
                                <div className="text-lg text-blue-900 font-serif bg-blue-50 p-2 rounded mb-3">{currentQ.original}</div>
                                <div className="text-sm text-gray-600 mb-4 bg-white border border-gray-100 p-2 rounded">
                                    <span className="font-bold text-blue-600 block mb-1">‚òÖËß£Ë™¨: {currentQ.category}</span> 
                                    {getGrammarHint(currentQ.category)}
                                    {currentQ.specificHint && <div className="mt-2 pt-2 border-t border-gray-100 text-xs text-gray-500"><span className="font-bold">Memo:</span> {currentQ.specificHint}</div>}
                                </div>
                                <button onClick={nextQuestion} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-md">Ê¨°„Å∏ÈÄ≤„ÇÄ</button>
                            </div>
                        ) : (
                            <div className="space-y-3 z-10 relative bg-white/80 md:bg-transparent p-2 rounded-xl backdrop-blur-sm md:backdrop-blur-none">
                                <div className="flex gap-2 animate-fadeIn pl-0 md:pl-56"> 
                                    <button onClick={() => setHintLevel(1)} disabled={hintLevel >= 1} className="flex-1 py-2 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg text-xs font-bold hover:bg-yellow-100 disabled:opacity-50 transition-colors"><HelpCircle size={14} className="inline mr-1"/> „Éí„É≥„Éà1:ÂãïË©û</button>
                                    <button onClick={() => setHintLevel(2)} disabled={hintLevel < 1 || hintLevel >= 2} className="flex-1 py-2 bg-orange-50 text-orange-800 border border-orange-200 rounded-lg text-xs font-bold hover:bg-orange-100 disabled:opacity-50 transition-colors"><BookOpen size={14} className="inline mr-1"/> „Éí„É≥„Éà2:ÊñáÊ≥ï+</button>
                                </div>
                                <div className="flex gap-2 pl-0 md:pl-56">
                                    <button onClick={handleGiveUp} className="px-4 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-300 text-sm whitespace-nowrap">Give up</button>
                                    <button onClick={checkAnswer} disabled={selectedWords.length !== currentQ.words.length} className={`flex-1 py-3 rounded-xl font-bold shadow-md transition-all text-lg ${selectedWords.length !== currentQ.words.length ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 hover:scale-[1.02]'}`}>Check</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
